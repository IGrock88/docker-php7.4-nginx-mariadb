version: '3'
services:
  java:
    container_name: ${APP_NAME:?err}-java
    restart: 'always'
    ports:
      - 12500:11111
    links:
      - php
    build:
      context: .
      dockerfile: ./docker/java.Dockerfile
    volumes:
      - ./java/logs:/var/java/app/target/logs

  webpack:
    container_name: ${APP_NAME:?err}-webpack
    build:
      context: .
      dockerfile: ./docker/node.Dockerfile
    volumes:
      - ./www/:/var/www/html/
    command: bash -c "yarn install && yarn ${WEBPACK_START_MODE:?build}"

  mariadb:
    image: mariadb:10.5.8
    container_name: ${APP_NAME:?err}-db
    restart: 'always'
    ports:
      - 37060:3306
    environment:
      MARIADB_PORT_NUMBER: 3306
      MARIADB_ROOT_USER: root
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:?err}
      MARIADB_DATABASE: check_printer_admin
    volumes:
      - check_printer_data:/var/lib/mysql

  memcache:
    container_name: ${APP_NAME:?err}-memcached
    restart: 'always'
    build:
      context: .
      dockerfile: ./docker/memcached.Dockerfile
    volumes:
      - ./www/:/var/www/html

  php:
    restart: 'always'
    links:
      - mariadb
      - memcache
    build:
      context: .
      dockerfile: ./docker/php.Dockerfile
    container_name: ${APP_NAME:?err}-php
    volumes:
      - './www/:/var/www/html'

  nginx:
    image: nginx:1.19.6-alpine
    restart: 'always'
    container_name: ${APP_NAME:?err}-nginx
    ports:
      - '12000:80'
      - '45443:443'
    links:
      - 'php'
    volumes:
      - './www:/var/www/html'
      - './config/nginx/fastcgi.conf:/etc/nginx/fastcgi.conf'
      - './config/nginx/nginx.conf:/etc/nginx/nginx.conf'
      - './config/nginx/snippets/:/etc/nginx/snippets/'
      - './config/nginx/conf:/etc/nginx/conf.d/'

  composer_installation:
    container_name: ${APP_NAME:?err}-composer
    build:
      context: .
      dockerfile: ./docker/composer.Dockerfile
    volumes:
      - ./www/:/var/www/html
    command: bash -c "composer install --no-scripts --no-autoloader --no-plugins --ignore-platform-reqs && composer dump-autoload"

#  mailer:
#    image: ${APP_NAME:?err}-imixs/exim4:latest
#    container_name: ${APP_NAME:?err}-mailer
#    restart: always
#    #build:
#    #  context: .
#    environment:
#      EXIM_SMARTHOST: smtp.yandex.ru:465
#      EXIM_PASSWORD: smtp.yandex.ru:${MAILER_LOGIN:?err}:${MAILER_PASSWORD:?err}
#      EXIM_ALLOWED_SENDERS: 172.18.0.0/24:127.0.0.1
#    volumes:
#      - ./var/log/exim4:/var/log/exim4


volumes:
  check_printer_data:
    external: true

